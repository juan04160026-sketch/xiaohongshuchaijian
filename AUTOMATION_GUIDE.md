# 小红书自动化发布指南

## 概述

本插件使用小红书 API 实现真正的自动化发布功能。通过直接调用 API，避免了浏览器自动化的复杂性和兼容性问题。

## 工作原理

### 1. 发布流程

```
登录小红书 API → 上传图片 → 创建笔记 → 发布内容 → 返回发布链接
```

### 2. 核心组件

**XhsApiClient** - 小红书 API 客户端
- 登录认证
- 图片上传
- 笔记创建
- Token 管理

**XhsPublishManager** - 多账号并发管理
- 管理多个 API 客户端
- 队列管理
- 并发控制（最多 3 个并发）
- 自动重试

**PublishScheduler** - 整体调度
- 从飞书读取数据
- 按时间触发发布
- 错误处理和恢复

## 安装

### 1. 安装依赖

```bash
npm install
```

这会安装所有必需的依赖包。

### 2. 首次运行

应用启动时会自动初始化，无需额外下载。

## 使用步骤

### 1. 配置小红书账号

在应用的"配置设置"中：
1. 点击"小红书账号管理"
2. 输入小红书用户名和密码
3. 点击"添加账号"

**注意**: 密码会被加密存储，不会以明文保存。

### 2. 准备飞书数据

在飞书多维表格中创建记录，包含：
- 小红书标题
- 小红书文案
- 小红书封面（图片 URL）
- 定时时间
- 状态（设置为"待发布"）

### 3. 开始发布

1. 点击"发布监控"标签
2. 点击"开始发布"按钮
3. 系统会自动：
   - 从飞书读取数据
   - 登录小红书账号
   - 按定时时间发布内容

### 4. 监控进度

在"发布监控"面板中可以看到：
- 发布进度（百分比）
- 实时状态日志
- 已发布/失败/待发布的数量

## 高级功能

### 1. 多账号并发发布

系统支持同时使用多个账号发布，最多 2 个并发浏览器。

```typescript
// 自动管理多个账号
const account1 = { username: 'user1', password: 'pass1' };
const account2 = { username: 'user2', password: 'pass2' };

// 系统会自动分配任务到不同账号
```

### 2. 自动重试

发布失败时会自动重试（最多 3 次）：
- 第 1 次重试：等待 1 秒
- 第 2 次重试：等待 2 秒
- 第 3 次重试：等待 5 秒

### 3. Cookie 管理

系统会自动保存登录 Cookie，下次发布时无需重新登录。

```
~/.xiaohongshu-auto-publish/cookies.json
```

### 4. 发布间隔控制

可以配置两次发布之间的等待时间，避免频繁发布导致账号限制。

默认间隔：30 秒

## 故障排除

### 问题 1: 登录失败

**原因**: 
- 用户名或密码错误
- 小红书网站结构变化
- 网络连接问题

**解决方案**:
1. 检查用户名和密码是否正确
2. 查看日志中的详细错误信息
3. 尝试手动登录小红书确认账号可用

### 问题 2: 发布超时

**原因**:
- 网络连接慢
- 小红书服务器响应慢
- 图片上传失败

**解决方案**:
1. 检查网络连接
2. 查看日志中的超时信息
3. 尝试减小图片文件大小

### 问题 3: 图片上传失败

**原因**:
- 图片 URL 无效
- 图片格式不支持
- 网络连接问题

**解决方案**:
1. 检查图片 URL 是否可访问
2. 确保图片格式为 JPG、PNG 等常见格式
3. 查看日志中的详细错误信息

### 问题 4: 内存占用过高

**原因**:
- 浏览器实例未正确关闭
- 长时间运行导致内存泄漏

**解决方案**:
1. 暂停发布，重启应用
2. 检查是否有异常的浏览器进程
3. 查看性能监控信息

## 性能指标

### 发布速度

- 单个发布耗时：30-60 秒
- 包括登录、上传、发布等步骤

### 并发能力

- 最多 2 个并发浏览器
- 队列管理自动分配任务

### 内存使用

- 单个浏览器实例：~150-200MB
- 2 个并发实例：~300-400MB

## 安全考虑

### 1. 凭证安全

- 密码使用 AES-256 加密存储
- Cookie 保存在本地，不上传到云端
- 错误日志中不包含敏感信息

### 2. 账号安全

- 建议使用专门的小红书账号
- 定期更改密码
- 监控账号登录活动

### 3. 内容安全

- 确保发布内容符合小红书规范
- 避免频繁发布导致账号限制
- 定期检查发布结果

## 常见问题

### Q: 为什么需要输入密码？

A: Playwright 需要真实的账号凭证来登录小红书。密码会被加密存储，不会以明文保存。

### Q: 可以使用多个账号吗？

A: 可以。系统支持添加多个账号，会自动分配任务到不同账号。

### Q: 发布失败后会怎样？

A: 系统会自动重试（最多 3 次），如果仍然失败，会记录错误信息供用户查看。

### Q: 可以暂停发布吗？

A: 可以。点击"暂停发布"按钮，系统会停止发布新任务。点击"继续发布"恢复。

### Q: 发布速度可以调整吗？

A: 可以。在"配置设置"中修改"发布间隔"参数。

## 技术细节

### API 配置

```typescript
const client = axios.create({
  baseURL: 'https://edith.xiaohongshu.com',
  timeout: 30000,
  headers: {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
  },
});
```

### 请求头

系统使用以下请求头避免被检测为自动化：
- 真实的 User-Agent
- 标准的 Content-Type
- 正确的 Authorization Token
- 合理的超时设置

### 错误处理

所有操作都包含错误处理和重试机制：
- 网络错误：自动重试
- 超时错误：增加超时时间
- 登录失败：提示用户重新授权

## 更新日志

### v1.2.0 (2024-12-16)

- ✅ 改用小红书 API 实现发布
- ✅ 移除浏览器自动化依赖
- ✅ 支持多账号并发发布（最多 3 个）
- ✅ 实现自动重试机制
- ✅ 完善错误处理
- ✅ 简化安装流程

## 支持

如有问题或建议，请：
1. 查看应用中的日志
2. 检查本指南中的故障排除部分
3. 提交 Issue 或联系支持

---

**最后更新**: 2024年12月16日
