<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°çº¢ä¹¦æœ¬åœ°å›¾æ–‡æ‰¹é‡åˆæˆå™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #ff2442;
            --secondary-color: #f5f5f5;
            --border-color: #ddd;
            --text-color: #333;
            --light-gray: #f0f0f0;
            --dark-gray: #666;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #fafafa;
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: var(--primary-color);
            font-size: 2rem;
            font-weight: bold;
            margin: 20px 0;
        }

        .main-content {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            flex-direction: row-reverse; /* å·¦è¾¹é¢„è§ˆï¼Œå³è¾¹æ§åˆ¶ */
        }

        /* å³ä¾§æ§åˆ¶åŒº */
        .control-panel {
            flex: 0 0 400px; /* å›ºå®šå®½åº¦ */
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-height: 90vh;
            overflow-y: auto;
        }

        .section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 12px;
            color: var(--text-color);
        }

        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background-color: #fff5f5;
        }

        .upload-area p {
            margin: 10px 0;
            color: var(--dark-gray);
        }

        .btn {
            display: inline-block;
            padding: 8px 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            transition: background-color 0.3s;
            font-size: 0.9rem;
        }

        .btn:hover:not(:disabled) {
            background-color: #e01e37;
        }

        .btn:disabled {
            background-color: var(--light-gray);
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: var(--light-gray);
            color: var(--text-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #e0e0e0;
        }

        textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            resize: vertical;
            font-family: inherit;
        }

        input[type="file"] {
            display: none;
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9rem;
            color: #666;
        }

        select, input[type="range"] {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .range-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .range-value {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
        }

        .position-controls {
            display: flex;
            gap: 15px;
        }

        .position-control {
            flex: 1;
        }

        .batch-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .counter {
            font-weight: bold;
            color: var(--dark-gray);
        }

        /* å·¦ä¾§é¢„è§ˆåŒº */
        .preview-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 600px;
        }

        .preview-container {
            width: 400px;
            height: 533px; /* 3:4 æ¯”ä¾‹ */
            background-color: var(--secondary-color);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            position: relative;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        .preview-text-container {
            position: relative;
            z-index: 2;
            padding: 16px;
            max-width: 100%;
            text-align: center;
            cursor: move;
            box-sizing: border-box;
            width: 100%;
        }

        .preview-text-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.3);
            z-index: -1;
            border-radius: 8px;
        }

        .preview-text {
            position: relative;
            color: #000;
            font-weight: bold;
            word-wrap: break-word;
            max-width: 100%;
            box-sizing: border-box;
            line-height: 1.2;
            margin: 0 auto;
            text-align: center;
            padding: 0 10px;
        }

        .empty-preview {
            color: var(--dark-gray);
            text-align: center;
            padding: 20px;
        }

        footer {
            text-align: center;
            color: var(--dark-gray);
            font-size: 0.9rem;
            margin-top: 30px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: #333;
            color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
        }

        .notification.show {
            transform: translateX(0);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .control-panel {
                flex: 1;
                max-width: 100%;
            }

            .preview-panel {
                align-items: center;
            }
            
            .preview-container {
                width: 300px;
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å°çº¢ä¹¦æœ¬åœ°å›¾æ–‡æ‰¹é‡åˆæˆå™¨</h1>
        </header>

        <div class="main-content">
            <!-- å·¦ä¾§æ“ä½œåŒº -->
            <div class="control-panel">
                <!-- èƒŒæ™¯å›¾ä¸Šä¼ æ¨¡å— -->
                <div class="section">
                    <h2 class="section-title">èƒŒæ™¯å›¾ä¸Šä¼ </h2>
                    <div class="upload-area" id="imageUploadArea">
                        <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</p>
                        <p>æ”¯æŒ JPG/PNG/WEBPï¼Œæœ€å¤§ 10MB</p>
                    </div>
                    <input type="file" id="imageInput" accept="image/*">
                    <div id="imageFileName" style="margin-top: 10px; font-size: 0.85rem; color: #666; display: none;">
                        å·²é€‰æ‹©ï¼š<span id="imageFileNameText"></span>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn" id="uploadImageBtn">é€‰æ‹©èƒŒæ™¯å›¾</button>
                        <button class="btn btn-secondary" id="resetImageBtn" disabled>é‡æ–°ä¸Šä¼ </button>
                    </div>
                </div>

                <!-- æ–‡å­—è¾“å…¥æ¨¡å— -->
                <div class="section">
                    <h2 class="section-title">æ–‡å­—è¾“å…¥</h2>
                    <div class="tabs">
                        <div class="tab active" data-tab="excel">Excel å¯¼å…¥</div>
                        <div class="tab" data-tab="manual">æ‰‹åŠ¨æ·»åŠ </div>
                    </div>

                    <!-- Excel å¯¼å…¥æ ‡ç­¾é¡µ -->
                    <div class="tab-content active" id="excelTab">
                        <div class="upload-area" id="excelUploadArea">
                            <p>ç‚¹å‡»æˆ–æ‹–æ‹½ Excel æ–‡ä»¶åˆ°æ­¤å¤„</p>
                            <p>æ”¯æŒ .xlsx/.xlsï¼Œæœ€å¤§ 5MB</p>
                        </div>
                        <input type="file" id="excelInput" accept=".xlsx,.xls">
                        <div id="excelSuccessMsg" style="margin-top: 10px; padding: 8px; background: #e8f5e9; color: #2e7d32; border-radius: 6px; font-size: 0.85rem; display: none;">
                            âœ” æˆåŠŸå¯¼å…¥ <span id="excelCount">0</span> æ¡æ•°æ®ï¼
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn" id="uploadExcelBtn">ä¸Šä¼  Excel æ–‡ä»¶</button>
                            <button class="btn btn-secondary" id="resetExcelBtn" disabled>é‡æ–°å¯¼å…¥</button>
                            <button class="btn btn-secondary" id="clearListBtn" disabled>æ¸…ç©ºåˆ—è¡¨</button>
                        </div>
                    </div>

                    <!-- æ‰‹åŠ¨æ·»åŠ æ ‡ç­¾é¡µ -->
                    <div class="tab-content" id="manualTab">
                        <div class="form-group">
                            <textarea id="manualInput" placeholder="è¾“å…¥æ–‡æ¡ˆï¼ˆæœ€å¤š 3 è¡Œï¼Œæ¯è¡Œä¸è¶…è¿‡ 20 å­—ï¼‰"></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn" id="addToListBtn">æ·»åŠ åˆ°åˆ—è¡¨</button>
                            <button class="btn btn-secondary" id="editTextBtn" disabled>ç¼–è¾‘é€‰ä¸­æ–‡å­—</button>
                        </div>
                    </div>
                </div>

                <!-- æ‰¹é‡åˆ‡æ¢æ¨¡å— -->
                <div class="section">
                    <div class="batch-controls">
                        <button class="btn" id="prevBtn" disabled>ä¸Šä¸€æ¡</button>
                        <div class="counter">å½“å‰ç¬¬ <span id="currentCount">0</span> æ¡ / å…± <span id="totalCount">0</span> æ¡</div>
                        <button class="btn" id="nextBtn" disabled>ä¸‹ä¸€æ¡</button>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-secondary" id="deleteTextBtn" disabled style="flex: 1;">åˆ é™¤å½“å‰æ–‡å­—</button>
                    </div>
                    
                    <!-- æ ‡é¢˜ç¼–è¾‘åŒºåŸŸ -->
                    <div id="titleEditArea" style="margin-top: 15px; display: none;">
                        <div style="background: #f5f5f5; padding: 10px; border-radius: 8px;">
                            <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 8px; color: #333;">
                                ğŸ“‹ æ ‡é¢˜ç¼–è¾‘<span id="titleEditNumber" style="margin-left: 5px;"></span>
                            </div>
                            <div class="form-group">
                                <label>æ ‡é¢˜å†…å®¹ï¼š</label>
                                <textarea id="titleContent" style="background: white; min-height: 60px; resize: vertical;"></textarea>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>IDå€¼ï¼š</label>
                                <input type="text" id="titleId" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: white;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é¢„è§ˆæ ‡é¢˜åˆ‡æ¢ -->
                <div class="section">
                    <h2 class="section-title">ğŸ”„ é¢„è§ˆæ ‡é¢˜åˆ‡æ¢</h2>
                    <div class="form-group">
                        <label>å½“å‰é¢„è§ˆï¼š</label>
                        <select id="previewSelect" style="width: 100%;">
                            <option value="">è¯·å…ˆå¯¼å…¥æ•°æ®</option>
                        </select>
                    </div>
                </div>

                <!-- å¯¼å‡ºè®¾ç½® -->
                <div class="section">
                    <h2 class="section-title">ğŸ“ å¯¼å‡ºè®¾ç½®</h2>
                    <div id="folderNotSelected" style="margin-bottom: 10px; color: #666; font-size: 0.85rem;">
                        æœªé€‰æ‹©æ–‡ä»¶å¤¹
                    </div>
                    <button class="btn btn-secondary" id="selectFolderBtn" style="width: 100%;">
                        é€‰æ‹©å¯¼å‡ºæ–‡ä»¶å¤¹
                    </button>
                    <div id="folderPath" style="margin-top: 10px; font-size: 0.85rem; color: #666; display: none;">
                        å·²é€‰æ‹©ï¼š<span id="folderPathText"></span>
                    </div>
                </div>

                <!-- æ–‡å­—æ ·å¼è°ƒæ•´æ¨¡å— -->
                <div class="section">
                    <h2 class="section-title">æ–‡å­—æ ·å¼</h2>
                    
                    <!-- æ ‡é¢˜å­—ä½“ -->
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <label style="margin: 0; min-width: 80px;">æ ‡é¢˜å­—ä½“:</label>
                        <select id="fontSelect" style="flex: 1; padding: 6px;">
                            <option value="'Source Han Sans', 'Noto Sans CJK', sans-serif">æ€æºé»‘ä½“</option>
                            <option value="'Microsoft YaHei', sans-serif" selected>å¾®è½¯é›…é»‘</option>
                            <option value="'PingFang SC', sans-serif">è‹¹æ–¹</option>
                            <option value="'Alibaba PuHuiTi', sans-serif">é˜¿é‡Œå·´å·´æ™®æƒ ä½“</option>
                            <option value="'SimSun', serif">å®‹ä½“</option>
                            <option value="'Source Han Serif CN', serif">æ€æºå®‹ä½“-ç»†ä½“</option>
                            <option value="'Ziyou Dict Black', sans-serif">å­—ç”±ç‚¹å­—å…¸é»‘</option>
                            <option value="'KEHUAWEIJINGKUIBEN-JIAN', sans-serif">å¯ç”»äº”ç»é­æœ¬-ç®€</option>
                            <option value="'KEHUASILIUNIAN-JIAN', sans-serif">å¯ç”»ä¼¼æµå¹´-ç®€</option>
                            <option value="'KEHUAXIAKEHANG-JIAN', sans-serif">å¯ç”»ä¾ å®¢è¡Œ-ç®€</option>
                            <option value="'KEHUAQIAOPIHEI-JIAN', sans-serif">å¯ç”»ä¿çš®é»‘-ç®€</option>
                            <option value="'KEHUAQUANFUSHOUSU-JIAN', sans-serif">å¯ç”»å…¨ç¦æ‰‹ä¹¦-ç®€</option>
                            <option value="'KEHUADIANYAHEI-JIAN', sans-serif">å¯ç”»å…¸é›…é»‘-ç®€</option>
                            <option value="'KEHUAFACOOTI-JIAN', sans-serif">å¯ç”»å‘é…·ä½“-ç®€</option>
                            <option value="'KEHUALINGYUNZHI-JIAN', sans-serif">å¯ç”»å‡Œäº‘å¿—-ç®€</option>
                            <option value="'KEHUALINGXIAOTI-JIAN', sans-serif">å¯ç”»å‡Œéœ„ä½“-ç®€</option>
                            <option value="'KEHUADAOJIANRUMENG', sans-serif">å¯ç”»åˆ€å‰‘å¦‚æ¢¦</option>
                            <option value="'KEHUALIBEI-JIAN', sans-serif">å¯ç”»åŠ›ç¢‘-ç®€</option>
                        </select>
                        <input type="color" id="textColorPicker" value="#000000" style="width: 40px; height: 35px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                    </div>

                    <!-- å¤§å° -->
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <label style="margin: 0; min-width: 80px;">å¤§å°:</label>
                        <input type="number" id="fontSizeInput" min="12" max="200" value="56" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>

                    <!-- æè¾¹ -->
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <label style="margin: 0; min-width: 80px;">æè¾¹:</label>
                        <input type="checkbox" id="strokeToggle" style="width: 20px; height: 20px; cursor: pointer;">
                        <input type="color" id="strokeColorPicker" value="#ff0000" style="width: 40px; height: 35px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                    </div>

                    <!-- åŠ ç²— -->
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <label style="margin: 0; min-width: 80px;">åŠ ç²—:</label>
                        <input type="checkbox" id="boldToggle" checked style="width: 20px; height: 20px; cursor: pointer;">
                    </div>

                    <!-- ä½ç½®X -->
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <label style="margin: 0; min-width: 80px;">ä½ç½®X:</label>
                        <input type="number" id="positionXInput" min="-500" max="500" value="0" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>

                    <!-- ä½ç½®Y -->
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <label style="margin: 0; min-width: 80px;">ä½ç½®Y:</label>
                        <input type="number" id="positionYInput" min="-500" max="500" value="0" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    
                    <button class="btn btn-secondary" id="resetPositionBtn" style="width: 100%; margin-top: 10px;">é‡ç½®ä½ç½®</button>
                </div>

                <!-- è£…é¥°å›¾æ ‡æ¨¡å— -->
                <div class="section">
                    <h2 class="section-title">ğŸ‰ è£…é¥°å›¾æ ‡</h2>
                    
                    <!-- å›¾æ ‡ä¸Šä¼  -->
                    <div class="form-group">
                        <label>å›¾æ ‡å›¾ç‰‡ï¼š</label>
                        <input type="file" id="iconInput" accept="image/*" style="display: none;">
                        <button class="btn btn-secondary" id="uploadIconBtn" style="width: 100%;">ä¸Šä¼ å›¾æ ‡</button>
                        <div id="iconFileName" style="margin-top: 8px; font-size: 0.85rem; color: #666; display: none;">
                            å·²é€‰æ‹©ï¼š<span id="iconFileNameText"></span>
                        </div>
                    </div>
                    
                    <!-- å›¾æ ‡å°ºå¯¸ -->
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <label style="margin: 0; min-width: 80px;">å›¾æ ‡å¤§å°:</label>
                        <input type="number" id="iconSizeInput" min="20" max="200" value="80" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    
                    <!-- å›¾æ ‡ä½ç½®X -->
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <label style="margin: 0; min-width: 80px;">å›¾æ ‡X:</label>
                        <input type="number" id="iconXInput" min="-500" max="500" value="-120" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    
                    <!-- å›¾æ ‡ä½ç½®Y -->
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <label style="margin: 0; min-width: 80px;">å›¾æ ‡Y:</label>
                        <input type="number" id="iconYInput" min="-500" max="500" value="-100" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    
                    <button class="btn btn-secondary" id="removeIconBtn" disabled style="width: 100%; margin-top: 10px;">ç§»é™¤å›¾æ ‡</button>
                </div>

                <!-- æ–‡å­—ä¸‹åˆ’è‰²å—æ¨¡å— -->
                <!-- è‰²å—åŠŸèƒ½å·²ç§»é™¤ -->

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="section">
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" id="previewBtn" style="flex: 1; background-color: #2196F3;">
                            ğŸ‘ï¸ é¢„è§ˆ
                        </button>
                        <button class="btn" id="generateBtn" disabled style="flex: 1; background-color: #4CAF50;">
                            ğŸ¨ ç”Ÿæˆ
                        </button>
                    </div>
                </div>
            </div>

            <!-- å·¦ä¾§é¢„è§ˆåŒº -->
            <div class="preview-panel">
                <div class="preview-container" id="previewContainer">
                    <div class="empty-preview" id="emptyPreview">è¯·å…ˆä¸Šä¼ èƒŒæ™¯å›¾</div>
                </div>
                <p>æ‹–åŠ¨æ–‡å­—å¯è°ƒæ•´ä½ç½®</p>
            </div>
        </div>

        <!-- åº•éƒ¨çŠ¶æ€æ  -->
        <div id="statusBar" style="background: #f5f5f5; padding: 12px 20px; border-radius: 8px; margin-top: 20px; text-align: center; font-size: 0.9rem; color: #666; display: none;">
            <strong>å½“å‰è®¾ç½®ï¼š</strong>
            <span id="statusText">é¢„è§ˆç¬¬ 1 å¼ å›¾ç‰‡ - æ˜¾ç¤ºæ ‡é¢˜6</span>
        </div>

        <footer>
            æœ¬åœ°è¿è¡Œãƒ»æ— éœ€è”ç½‘ | æ”¯æŒ Excel ç¬¬äºŒåˆ—å¯¼å…¥ | è°ƒæ•´å®Œæˆåæˆªå›¾ä¿å­˜
        </footer>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // å…¨å±€å˜é‡
        let backgroundImage = null;
        let backgroundImageName = ''; // èƒŒæ™¯å›¾æ–‡ä»¶å
        let decorativeIcon = null; // è£…é¥°å›¾æ ‡
        let decorativeIconName = ''; // å›¾æ ‡æ–‡ä»¶å
        let textList = [];
        let idList = []; // å­˜åƒ­IDåˆ—è¡¨ï¼ˆå¯¹åº”Excelçš„Aåˆ—ï¼‰
        let currentIndex = 0;
        let previewIndex = 0; // é¢„è§ˆç´¢å¼•ï¼ˆå¯ä»¥ä¸ç¼–è¾‘ç´¢å¼•ä¸åŒï¼‰
        let exportFolder = ''; // å¯¼å‡ºæ–‡ä»¶å¤¹è·¯å¾„
        let exportFolderHandle = null; // æ–‡ä»¶å¤¹å¥æŸ„ï¼ˆç”¨äº File System Access APIï¼‰
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;
        let dragStartX, dragStartY;
        // ä¸ºæ¯ä¸ªæ–‡å­—é¡¹å­˜å‚¨ç‹¬ç«‹çš„åç§»é‡
        let textOffsets = [];

        // DOM å…ƒç´ 
        const elements = {
            imageUploadArea: document.getElementById('imageUploadArea'),
            imageInput: document.getElementById('imageInput'),
            uploadImageBtn: document.getElementById('uploadImageBtn'),
            resetImageBtn: document.getElementById('resetImageBtn'),
            imageFileName: document.getElementById('imageFileName'),
            imageFileNameText: document.getElementById('imageFileNameText'),
            excelUploadArea: document.getElementById('excelUploadArea'),
            excelInput: document.getElementById('excelInput'),
            uploadExcelBtn: document.getElementById('uploadExcelBtn'),
            resetExcelBtn: document.getElementById('resetExcelBtn'),
            clearListBtn: document.getElementById('clearListBtn'),
            excelSuccessMsg: document.getElementById('excelSuccessMsg'),
            excelCount: document.getElementById('excelCount'),
            manualInput: document.getElementById('manualInput'),
            addToListBtn: document.getElementById('addToListBtn'),
            editTextBtn: document.getElementById('editTextBtn'),
            deleteTextBtn: document.getElementById('deleteTextBtn'),
            titleEditArea: document.getElementById('titleEditArea'),
            titleEditNumber: document.getElementById('titleEditNumber'),
            titleContent: document.getElementById('titleContent'),
            titleId: document.getElementById('titleId'),
            previewSelect: document.getElementById('previewSelect'),
            selectFolderBtn: document.getElementById('selectFolderBtn'),
            folderNotSelected: document.getElementById('folderNotSelected'),
            folderPath: document.getElementById('folderPath'),
            folderPathText: document.getElementById('folderPathText'),
            previewBtn: document.getElementById('previewBtn'),
            generateBtn: document.getElementById('generateBtn'),
            statusBar: document.getElementById('statusBar'),
            statusText: document.getElementById('statusText'),
            tabs: document.querySelectorAll('.tab'),
            tabContents: document.querySelectorAll('.tab-content'),
            fontSelect: document.getElementById('fontSelect'),
            fontSizeInput: document.getElementById('fontSizeInput'),
            textColorPicker: document.getElementById('textColorPicker'),
            strokeToggle: document.getElementById('strokeToggle'),
            strokeColorPicker: document.getElementById('strokeColorPicker'),
            boldToggle: document.getElementById('boldToggle'),
            positionXInput: document.getElementById('positionXInput'),
            positionYInput: document.getElementById('positionYInput'),
            resetPositionBtn: document.getElementById('resetPositionBtn'),
            iconInput: document.getElementById('iconInput'),
            uploadIconBtn: document.getElementById('uploadIconBtn'),
            removeIconBtn: document.getElementById('removeIconBtn'),
            iconFileName: document.getElementById('iconFileName'),
            iconFileNameText: document.getElementById('iconFileNameText'),
            iconSizeInput: document.getElementById('iconSizeInput'),
            iconXInput: document.getElementById('iconXInput'),
            iconYInput: document.getElementById('iconYInput'),
            // è‰²å—åŠŸèƒ½å·²ç§»é™¤
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),
            currentCount: document.getElementById('currentCount'),
            totalCount: document.getElementById('totalCount'),
            previewContainer: document.getElementById('previewContainer'),
            emptyPreview: document.getElementById('emptyPreview'),
            notification: document.getElementById('notification')
        };

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            bindEvents();
            updateBatchControls();
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // èƒŒæ™¯å›¾ä¸Šä¼ 
            elements.uploadImageBtn.addEventListener('click', () => elements.imageInput.click());
            elements.imageInput.addEventListener('change', handleImageUpload);
            elements.resetImageBtn.addEventListener('click', resetBackgroundImage);
            
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸä¹Ÿèƒ½è§¦å‘æ–‡ä»¶é€‰æ‹©
            elements.imageUploadArea.addEventListener('click', () => elements.imageInput.click());
            
            // æ‹–æ‹½ä¸Šä¼ èƒŒæ™¯å›¾
            elements.imageUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.imageUploadArea.style.borderColor = '#ff2442';
                elements.imageUploadArea.style.backgroundColor = '#fff5f5';
            });
            
            elements.imageUploadArea.addEventListener('dragleave', () => {
                elements.imageUploadArea.style.borderColor = '#ddd';
                elements.imageUploadArea.style.backgroundColor = '';
            });
            
            elements.imageUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.imageUploadArea.style.borderColor = '#ddd';
                elements.imageUploadArea.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length) {
                    elements.imageInput.files = e.dataTransfer.files;
                    handleImageUpload();
                }
            });

            // Excel å¯¼å…¥
            elements.uploadExcelBtn.addEventListener('click', () => elements.excelInput.click());
            elements.excelInput.addEventListener('change', handleExcelUpload);
            elements.resetExcelBtn.addEventListener('click', resetExcelImport);
            elements.clearListBtn.addEventListener('click', clearTextList);
            
            // ç‚¹å‡»Excelä¸Šä¼ åŒºåŸŸä¹Ÿèƒ½è§¦å‘æ–‡ä»¶é€‰æ‹©
            elements.excelUploadArea.addEventListener('click', () => elements.excelInput.click());
            
            // æ‹–æ‹½ä¸Šä¼  Excel
            elements.excelUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.excelUploadArea.style.borderColor = '#ff2442';
                elements.excelUploadArea.style.backgroundColor = '#fff5f5';
            });
            
            elements.excelUploadArea.addEventListener('dragleave', () => {
                elements.excelUploadArea.style.borderColor = '#ddd';
                elements.excelUploadArea.style.backgroundColor = '';
            });
            
            elements.excelUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.excelUploadArea.style.borderColor = '#ddd';
                elements.excelUploadArea.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length) {
                    elements.excelInput.files = e.dataTransfer.files;
                    handleExcelUpload();
                }
            });

            // æ‰‹åŠ¨è¾“å…¥
            elements.addToListBtn.addEventListener('click', addManualTextToList);
            elements.editTextBtn.addEventListener('click', editCurrentText);
            // å®æ—¶é¢„è§ˆï¼šç›‘å¬è¾“å…¥æ¡†çš„å†…å®¹å˜åŒ–
            elements.manualInput.addEventListener('input', handleManualInputChange);

            // æ ‡ç­¾é¡µåˆ‡æ¢
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });

            // æ–‡å­—æ ·å¼è°ƒæ•´
            elements.fontSelect.addEventListener('change', updatePreviewRealtime);
            elements.fontSizeInput.addEventListener('input', updatePreviewRealtime);
            elements.textColorPicker.addEventListener('input', updatePreviewRealtime);
            elements.strokeToggle.addEventListener('change', updatePreviewRealtime);
            elements.strokeColorPicker.addEventListener('input', updatePreviewRealtime);
            elements.boldToggle.addEventListener('change', updatePreviewRealtime);

            // ä½ç½®è°ƒæ•´
            elements.positionXInput.addEventListener('input', () => {
                offsetX = parseInt(elements.positionXInput.value) || 0;
                // åŒæ­¥æ›´æ–°åˆ—è¡¨é¡¹çš„åç§»é‡
                if (textList.length > 0 && textOffsets[currentIndex]) {
                    textOffsets[currentIndex].x = offsetX;
                }
                // å®æ—¶æ›´æ–°é¢„è§ˆ
                updatePreviewRealtime();
            });
            
            elements.positionYInput.addEventListener('input', () => {
                offsetY = parseInt(elements.positionYInput.value) || 0;
                // åŒæ­¥æ›´æ–°åˆ—è¡¨é¡¹çš„åç§»é‡
                if (textList.length > 0 && textOffsets[currentIndex]) {
                    textOffsets[currentIndex].y = offsetY;
                }
                // å®æ—¶æ›´æ–°é¢„è§ˆ
                updatePreviewRealtime();
            });
            
            elements.resetPositionBtn.addEventListener('click', resetPosition);

            // è£…é¥°å›¾æ ‡
            elements.uploadIconBtn.addEventListener('click', () => elements.iconInput.click());
            elements.iconInput.addEventListener('change', handleIconUpload);
            elements.removeIconBtn.addEventListener('click', removeIcon);
            elements.iconSizeInput.addEventListener('input', updatePreviewRealtime);
            elements.iconXInput.addEventListener('input', updatePreviewRealtime);
            elements.iconYInput.addEventListener('input', updatePreviewRealtime);
            
            // æ–‡å­—ä¸‹åˆ’è‰²å—
            // è‰²å—åŠŸèƒ½å·²ç§»é™¤

            // æ‰¹é‡åˆ‡æ¢
            elements.prevBtn.addEventListener('click', showPrevText);
            elements.nextBtn.addEventListener('click', showNextText);
            elements.deleteTextBtn.addEventListener('click', deleteCurrentText);
            
            // é¢„è§ˆæ ‡é¢˜åˆ‡æ¢
            elements.previewSelect.addEventListener('change', handlePreviewSelectChange);
            
            // æ ‡é¢˜ç¼–è¾‘åŒºåŸŸå®æ—¶åŒæ­¥é¢„è§ˆ
            elements.titleContent.addEventListener('input', handleTitleContentChange);
            
            // å¯¼å‡ºæ–‡ä»¶å¤¹é€‰æ‹©
            elements.selectFolderBtn.addEventListener('click', selectExportFolder);
            
            // é¢„è§ˆå’Œç”ŸæˆæŒ‰é’®
            elements.previewBtn.addEventListener('click', handlePreview);
            elements.generateBtn.addEventListener('click', handleGenerate);

            // æ–‡å­—æ‹–åŠ¨
            // æ³¨æ„ï¼šè¿™é‡Œæ”¹ä¸ºåœ¨æ–‡å­—å®¹å™¨ä¸Šç»‘å®šäº‹ä»¶ï¼Œè€Œä¸æ˜¯åœ¨æ•´ä¸ªé¢„è§ˆå®¹å™¨ä¸Š
            // elements.previewContainer.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);
            
            // è‰²å—æ‹–åŠ¨äº‹ä»¶
            // è‰²å—åŠŸèƒ½å·²ç§»é™¤
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            elements.tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            elements.tabContents.forEach(content => {
                if (content.id === `${tabName}Tab`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        // å¤„ç†èƒŒæ™¯å›¾ä¸Šä¼ 
        function handleImageUpload() {
            const file = elements.imageInput.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            if (file.size > 10 * 1024 * 1024) {
                showToast('ä»…æ”¯æŒ JPG/PNG/WEBPï¼Œæœ€å¤§ 10MB');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.match('image.*')) {
                showToast('ä»…æ”¯æŒ JPG/PNG/WEBP æ ¼å¼');
                return;
            }
            
            // ä¿å­˜æ–‡ä»¶å
            backgroundImageName = file.name;
            elements.imageFileNameText.textContent = backgroundImageName;
            elements.imageFileName.style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                backgroundImage = new Image();
                backgroundImage.onload = function() {
                    elements.resetImageBtn.disabled = false;
                    elements.emptyPreview.textContent = 'æš‚æ— æ–‡å­—ï¼Œè¯·å¯¼å…¥ Excel æˆ–æ‰‹åŠ¨æ·»åŠ ';
                    updatePreview();
                    showToast('èƒŒæ™¯å›¾ä¸Šä¼ æˆåŠŸ');
                };
                backgroundImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // é‡ç½®èƒŒæ™¯å›¾
        function resetBackgroundImage() {
            elements.imageInput.value = '';
            backgroundImage = null;
            backgroundImageName = '';
            elements.imageFileName.style.display = 'none';
            elements.resetImageBtn.disabled = true;
            elements.emptyPreview.textContent = 'è¯·å…ˆä¸Šä¼ èƒŒæ™¯å›¾';
            updatePreview();
        }

        // å¤„ç†å›¾æ ‡ä¸Šä¼ 
        function handleIconUpload() {
            const file = elements.iconInput.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            if (file.size > 5 * 1024 * 1024) {
                showToast('å›¾æ ‡æ–‡ä»¶æœ€å¤§ 5MB');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.match('image.*')) {
                showToast('ä»…æ”¯æŒå›¾ç‰‡æ ¼å¼');
                return;
            }
            
            // ä¿å­˜æ–‡ä»¶å
            decorativeIconName = file.name;
            elements.iconFileNameText.textContent = decorativeIconName;
            elements.iconFileName.style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                decorativeIcon = new Image();
                decorativeIcon.onload = function() {
                    elements.removeIconBtn.disabled = false;
                    updatePreviewSmart();
                    showToast('å›¾æ ‡ä¸Šä¼ æˆåŠŸ');
                };
                decorativeIcon.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ç§»é™¤å›¾æ ‡
        function removeIcon() {
            elements.iconInput.value = '';
            decorativeIcon = null;
            decorativeIconName = '';
            elements.iconFileName.style.display = 'none';
            elements.removeIconBtn.disabled = true;
            updatePreviewSmart();
            showToast('å›¾æ ‡å·²ç§»é™¤');
        }

        // å¤„ç† Excel ä¸Šä¼ 
        function handleExcelUpload() {
            const file = elements.excelInput.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            if (file.size > 5 * 1024 * 1024) {
                showToast('Excel æœ€å¤§ 5MB');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showToast('ä»…æ”¯æŒ .xlsx/.xls æ ¼å¼');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // å°è¯•ä¸åŒçš„è§£ææ–¹å¼
                    let jsonData;
                    try {
                        // é¦–å…ˆå°è¯• {header: 1} æ–¹å¼
                        jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    } catch (headerError) {
                        try {
                            // å¦‚æœå¤±è´¥ï¼Œå°è¯•é»˜è®¤æ–¹å¼
                            jsonData = XLSX.utils.sheet_to_json(worksheet);
                        } catch (defaultError) {
                            throw new Error('æ— æ³•è§£æExcelæ–‡ä»¶');
                        }
                    }
                    
                    // æå–ç¬¬ä¸€åˆ—ï¼ˆAåˆ—-IDï¼‰å’Œç¬¬äºŒåˆ—ï¼ˆBåˆ—-æ ‡é¢˜ï¼‰çš„æ‰€æœ‰éç©ºæ–‡å­—
                    const newTexts = [];
                    const newIds = [];
                    
                    // å¦‚æœæ˜¯æ•°ç»„æ ¼å¼ï¼ˆ{header: 1}ï¼‰
                    if (Array.isArray(jsonData) && jsonData.length > 0 && Array.isArray(jsonData[0])) {
                        // è·³è¿‡ç¬¬ä¸€è¡Œï¼ˆæ ‡é¢˜è¡Œï¼‰ï¼Œä»ç¬¬äºŒè¡Œå¼€å§‹
                        for (let i = 1; i < jsonData.length; i++) {
                            const idValue = jsonData[i][0] ? jsonData[i][0].toString() : '';
                            const titleValue = jsonData[i][1] ? jsonData[i][1].toString() : '';
                            
                            // åªæ·»åŠ Båˆ—æœ‰å†…å®¹çš„è¡Œ
                            if (titleValue !== '') {
                                newIds.push(idValue);
                                // ä¿æŒåŸå§‹æ ¼å¼ï¼Œä¸å¤„ç†æ¢è¡Œç¬¦
                                newTexts.push(titleValue);
                            }
                        }
                    } 
                    // å¦‚æœæ˜¯å¯¹è±¡æ•°ç»„æ ¼å¼ï¼ˆé»˜è®¤ï¼‰
                    else if (Array.isArray(jsonData) && jsonData.length > 0 && typeof jsonData[0] === 'object') {
                        // è·å–æ‰€æœ‰é”®å
                        const keys = Object.keys(jsonData[0]);
                        const firstColumnKey = keys[0] || 'A';
                        const secondColumnKey = keys.length > 1 ? keys[1] : 'B';
                        
                        for (let i = 0; i < jsonData.length; i++) {
                            const idValue = jsonData[i][firstColumnKey] ? jsonData[i][firstColumnKey].toString() : '';
                            const titleValue = jsonData[i][secondColumnKey] ? jsonData[i][secondColumnKey].toString() : '';
                            
                            // åªæ·»åŠ Båˆ—æœ‰å†…å®¹çš„è¡Œ
                            if (titleValue !== '') {
                                newIds.push(idValue);
                                // ä¿æŒåŸå§‹æ ¼å¼ï¼Œä¸å¤„ç†æ¢è¡Œç¬¦
                                newTexts.push(titleValue);
                            }
                        }
                    }
                    
                    if (newTexts.length === 0) {
                        showToast('ç¬¬äºŒåˆ—æ— éç©ºæ–‡å­—');
                        return;
                    }
                    
                    textList = newTexts;
                    idList = newIds;
                    // ä¸ºæ¯ä¸ªå¯¼å…¥çš„æ–‡å­—åˆå§‹åŒ–åç§»é‡
                    textOffsets = newTexts.map(() => ({x: 0, y: 0}));
                    currentIndex = 0;
                    elements.resetExcelBtn.disabled = false;
                    elements.clearListBtn.disabled = false;
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    elements.excelCount.textContent = newTexts.length;
                    elements.excelSuccessMsg.style.display = 'block';
                    
                    updateBatchControls();
                    updatePreview();
                    updateTitleEdit(); // æ›´æ–°æ ‡é¢˜ç¼–è¾‘åŒºåŸŸ
                    showToast(`æˆåŠŸå¯¼å…¥ ${newTexts.length} æ¡æ–‡å­—`);
                } catch (error) {
                    showToast('Excel è§£æå¤±è´¥: ' + error.message);
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // é‡ç½® Excel å¯¼å…¥
        function resetExcelImport() {
            elements.excelInput.value = '';
            elements.resetExcelBtn.disabled = true;
            // ä¸æ¸…ç©ºæ–‡å­—åˆ—è¡¨ï¼Œå› ä¸ºå¯èƒ½è¿˜æœ‰æ‰‹åŠ¨æ·»åŠ çš„æ–‡å­—
        }

        // æ¸…ç©ºæ–‡å­—åˆ—è¡¨
        function clearTextList() {
            textList = [];
            idList = [];
            textOffsets = [];
            currentIndex = 0;
            elements.clearListBtn.disabled = true;
            elements.excelSuccessMsg.style.display = 'none';
            updateBatchControls();
            updateTitleEdit();
            updatePreview();
        }

        // æ·»åŠ æ‰‹åŠ¨è¾“å…¥çš„æ–‡å­—åˆ°åˆ—è¡¨
        function addManualTextToList() {
            const text = elements.manualInput.value;
            // å…è®¸ç©ºæ–‡æœ¬ï¼ˆåŒ…æ‹¬åªæœ‰æ¢è¡Œç¬¦çš„æ–‡æœ¬ï¼‰
            if (text === null || text === undefined) {
                showToast('è¯·è¾“å…¥æ–‡å­—');
                return;
            }
            
            // é™åˆ¶æœ€å¤š 3 è¡Œï¼Œæ¯è¡Œæœ€å¤š 20 å­—ï¼ˆä½†å…è®¸ç©ºè¡Œï¼‰
            const lines = text.split('\n');
            if (lines.length > 3) {
                showToast('æœ€å¤š 3 è¡Œï¼Œå·²è‡ªåŠ¨æˆªæ–­');
                lines.splice(3);
            }
            
            const processedLines = lines.map(line => {
                if (line.length > 20) {
                    showToast('æ¯è¡Œæœ€å¤š 20 å­—ï¼Œå·²è‡ªåŠ¨æˆªæ–­');
                    return line.substring(0, 20);
                }
                return line;
            });
            
            const processedText = processedLines.join('\n');
            
            // æ£€æŸ¥æ˜¯å¦åœ¨ç¼–è¾‘æ¨¡å¼ï¼ˆæ‰‹åŠ¨è¾“å…¥æ¡†ä¸­æœ‰å†…å®¹ä¸”å½“å‰æœ‰é€‰ä¸­çš„æ–‡å­—ï¼‰
            const manualTabActive = document.getElementById('manualTab').classList.contains('active');
            if (manualTabActive && textList.length > 0 && elements.manualInput.value !== '') {
                // æ›´æ–°å½“å‰é€‰ä¸­çš„æ–‡å­—
                textList[currentIndex] = processedText;
                showToast('å·²æ›´æ–°å½“å‰æ–‡å­—');
            } else {
                // æ–°å¢æ–‡å­—
                textList.push(processedText);
                // ä¸ºæ–°æ·»åŠ çš„æ–‡å­—åˆå§‹åŒ–åç§»é‡
                textOffsets.push({x: 0, y: 0});
                showToast('å·²æ·»åŠ æ–°æ–‡å­—');
            }
            
            elements.manualInput.value = '';
            elements.clearListBtn.disabled = false;
            updateBatchControls();
            updateTitleEdit();
            updatePreview();
        }

        // ç¼–è¾‘å½“å‰é€‰ä¸­çš„æ–‡å­—
        function editCurrentText() {
            if (textList.length === 0) {
                showToast('æ²¡æœ‰å¯ç¼–è¾‘çš„æ–‡å­—');
                return;
            }
            
            // å°†å½“å‰é€‰ä¸­çš„æ–‡å­—å¡«å……åˆ°è¾“å…¥æ¡†ä¸­
            elements.manualInput.value = textList[currentIndex];
            
            // åˆ‡æ¢åˆ°æ‰‹åŠ¨æ·»åŠ æ ‡ç­¾é¡µ
            switchTab('manual');
            
            showToast('å·²åŠ è½½å½“å‰æ–‡å­—åˆ°ç¼–è¾‘æ¡†ï¼Œä¿®æ”¹åè¯·ç‚¹å‡»"æ·»åŠ åˆ°åˆ—è¡¨"æŒ‰é’®æ›´æ–°');
        }

        // å¤„ç†æ‰‹åŠ¨è¾“å…¥æ¡†å†…å®¹å˜åŒ–ï¼ˆå®æ—¶é¢„è§ˆï¼‰
        function handleManualInputChange() {
            const text = elements.manualInput.value;
            
            // å¦‚æœæ²¡æœ‰èƒŒæ™¯å›¾ï¼Œä¸éœ€è¦æ›´æ–°é¢„è§ˆ
            if (!backgroundImage) {
                return;
            }
            
            // ç›´æ¥æ›´æ–°é¢„è§ˆæ˜¾ç¤ºè¾“å…¥æ¡†çš„å†…å®¹ï¼ˆåŒ…æ‹¬ç©ºå†…å®¹ï¼‰
            updatePreviewWithText(text);
        }
        
        // å¤„ç†æ ‡é¢˜ç¼–è¾‘åŒºåŸŸå†…å®¹å˜åŒ–ï¼ˆå®æ—¶åŒæ­¥é¢„è§ˆï¼‰
        function handleTitleContentChange() {
            const text = elements.titleContent.value;
            
            // æ›´æ–°åˆ—è¡¨ä¸­çš„æ•°æ®
            if (textList.length > 0 && currentIndex >= 0 && currentIndex < textList.length) {
                textList[currentIndex] = text;
            }
            
            // å¦‚æœæ²¡æœ‰èƒŒæ™¯å›¾ï¼Œä¸éœ€è¦æ›´æ–°é¢„è§ˆ
            if (!backgroundImage) {
                return;
            }
            
            // å®æ—¶æ›´æ–°é¢„è§ˆ
            updatePreviewWithText(text);
        }
        
        // å®æ—¶æ›´æ–°é¢„è§ˆï¼ˆç»Ÿä¸€å¤„ç†å„ç§è¾“å…¥å˜åŒ–ï¼‰
        function updatePreviewRealtime() {
            if (!backgroundImage) {
                return;
            }
            
            // è·å–å½“å‰åº”è¯¥æ˜¾ç¤ºçš„æ–‡å­—
            let currentText = '';
            
            // ä¼˜å…ˆä½¿ç”¨æ ‡é¢˜ç¼–è¾‘åŒºåŸŸçš„å†…å®¹
            if (elements.titleEditArea.style.display !== 'none' && elements.titleContent.value) {
                currentText = elements.titleContent.value;
            }
            // å…¶æ¬¡æ£€æŸ¥æ‰‹åŠ¨è¾“å…¥æ¨¡å¼
            else if (document.getElementById('manualTab').classList.contains('active') && elements.manualInput.value) {
                currentText = elements.manualInput.value;
            }
            // æœ€åä½¿ç”¨åˆ—è¡¨ä¸­çš„æ•°æ®
            else if (textList.length > 0 && currentIndex >= 0 && currentIndex < textList.length) {
                currentText = textList[currentIndex];
            }
            
            updatePreviewWithText(currentText);
        }

        // æ™ºèƒ½æ›´æ–°é¢„è§ˆï¼šæ£€æµ‹æ˜¯å¦æœ‰æ‰‹åŠ¨è¾“å…¥çš„æ–‡å­—
        function updatePreviewSmart() {
            // æ£€æŸ¥æ˜¯å¦åœ¨æ‰‹åŠ¨æ·»åŠ æ¨¡å¼ä¸‹ï¼Œä¸”è¾“å…¥æ¡†æœ‰å†…å®¹
            const manualTabActive = document.getElementById('manualTab').classList.contains('active');
            const manualInputText = elements.manualInput.value;
            
            // å¦‚æœåœ¨æ‰‹åŠ¨æ¨¡å¼ä¸”è¾“å…¥æ¡†æœ‰å†…å®¹ï¼Œä½¿ç”¨è¾“å…¥æ¡†çš„æ–‡å­—
            if (manualTabActive && manualInputText !== '') {
                updatePreviewWithText(manualInputText);
            } else if (textList.length > 0) {
                // å¦‚æœæœ‰åˆ—è¡¨æ•°æ®ï¼Œä½¿ç”¨æ™®é€šé¢„è§ˆ
                updatePreview();
            } else {
                // å¦‚æœæ²¡æœ‰æ•°æ®ä½†æœ‰èƒŒæ™¯å›¾ï¼Œä¹Ÿè¦æ›´æ–°é¢„è§ˆä»¥æ˜¾ç¤ºç©ºçŠ¶æ€
                updatePreview();
            }
        }

        // é‡ç½®ä½ç½®
        function resetPosition() {
            // é‡ç½®å½“å‰æ–‡å­—é¡¹çš„åç§»é‡
            if (!textOffsets[currentIndex]) {
                textOffsets[currentIndex] = {x: 0, y: 0};
            } else {
                textOffsets[currentIndex].x = 0;
                textOffsets[currentIndex].y = 0;
            }
            
            offsetX = 0;
            offsetY = 0;
            elements.positionXInput.value = 0;
            elements.positionYInput.value = 0;
            updatePreview();
        }

        // æ˜¾ç¤ºä¸Šä¸€æ¡æ–‡å­—
        function showPrevText() {
            if (textList.length === 0) return;
            currentIndex = (currentIndex - 1 + textList.length) % textList.length;
            updateBatchControls();
            updateTitleEdit();
            updatePreview();
        }

        // æ˜¾ç¤ºä¸‹ä¸€æ¡æ–‡å­—
        function showNextText() {
            if (textList.length === 0) return;
            currentIndex = (currentIndex + 1) % textList.length;
            updateBatchControls();
            updateTitleEdit();
            updatePreview();
        }

        // åˆ é™¤å½“å‰æ–‡å­—
        function deleteCurrentText() {
            if (textList.length === 0) {
                showToast('æ²¡æœ‰å¯åˆ é™¤çš„æ–‡å­—');
                return;
            }
            
            // ä»åˆ—è¡¨ä¸­åˆ é™¤å½“å‰æ–‡å­—ã€IDåŠå…¶åç§»é‡
            textList.splice(currentIndex, 1);
            idList.splice(currentIndex, 1);
            textOffsets.splice(currentIndex, 1);
            
            // è°ƒæ•´å½“å‰ç´¢å¼•
            if (currentIndex >= textList.length && textList.length > 0) {
                currentIndex = textList.length - 1;
            }
            
            // å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œé‡ç½®ç´¢å¼•
            if (textList.length === 0) {
                currentIndex = 0;
                elements.clearListBtn.disabled = true;
            }
            
            updateBatchControls();
            updateTitleEdit();
            updatePreview();
            showToast('å·²åˆ é™¤å½“å‰æ–‡å­—');
        }

        // æ›´æ–°æ‰¹é‡æ§åˆ¶æŒ‰é’®çŠ¶æ€
        function updateBatchControls() {
            const hasText = textList.length > 0;
            elements.prevBtn.disabled = !hasText;
            elements.nextBtn.disabled = !hasText;
            elements.generateBtn.disabled = !(backgroundImage && hasText && exportFolder);
            elements.editTextBtn.disabled = !hasText;
            elements.deleteTextBtn.disabled = !hasText;
            elements.currentCount.textContent = hasText ? currentIndex + 1 : 0;
            elements.totalCount.textContent = textList.length;
            updatePreviewSelectOptions();
            updateStatusBar();
        }
        
        // æ›´æ–°æ ‡é¢˜ç¼–è¾‘åŒºåŸŸ
        function updateTitleEdit() {
            if (textList.length > 0 && idList.length > 0) {
                elements.titleEditArea.style.display = 'block';
                elements.titleEditNumber.textContent = currentIndex + 1;
                elements.titleContent.value = textList[currentIndex] || '';
                elements.titleId.value = idList[currentIndex] || '';
            } else {
                elements.titleEditArea.style.display = 'none';
            }
        }
        
        // æ›´æ–°é¢„è§ˆé€‰æ‹©ä¸‹æ‹‰æ¡†é€‰é¡¹
        function updatePreviewSelectOptions() {
            if (textList.length === 0) {
                elements.previewSelect.innerHTML = '<option value="">è¯·å…ˆå¯¼å…¥æ•°æ®</option>';
                return;
            }
            
            elements.previewSelect.innerHTML = '';
            textList.forEach((text, index) => {
                const option = document.createElement('option');
                option.value = index;
                const preview = text.split('\n')[0].substring(0, 10);
                option.textContent = `æ ‡é¢˜${index + 1}`;
                if (index === previewIndex) {
                    option.selected = true;
                }
                elements.previewSelect.appendChild(option);
            });
        }
        
        // å¤„ç†é¢„è§ˆé€‰æ‹©å˜åŒ–
        function handlePreviewSelectChange() {
            const selectedIndex = parseInt(elements.previewSelect.value);
            if (!isNaN(selectedIndex) && selectedIndex >= 0 && selectedIndex < textList.length) {
                previewIndex = selectedIndex;
                updateStatusBar();
                // æ›´æ–°é¢„è§ˆæ˜¾ç¤ºé€‰ä¸­çš„æ ‡é¢˜
                currentIndex = previewIndex;
                updateBatchControls();
                updateTitleEdit();
                updatePreview();
            }
        }
        
        // é€‰æ‹©å¯¼å‡ºæ–‡ä»¶å¤¹
        async function selectExportFolder() {
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ File System Access API
            if ('showDirectoryPicker' in window) {
                try {
                    // ä½¿ç”¨ç°ä»£ API é€‰æ‹©æ–‡ä»¶å¤¹
                    const dirHandle = await window.showDirectoryPicker();
                    exportFolderHandle = dirHandle;
                    exportFolder = dirHandle.name;
                    
                    elements.folderNotSelected.style.display = 'none';
                    elements.folderPath.style.display = 'block';
                    elements.folderPathText.textContent = dirHandle.name;
                    updateBatchControls();
                    showToast('æ–‡ä»¶å¤¹é€‰æ‹©æˆåŠŸ');
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('é€‰æ‹©æ–‡ä»¶å¤¹å¤±è´¥:', err);
                        showToast('æ–‡ä»¶å¤¹é€‰æ‹©å¤±è´¥');
                    }
                }
            } else {
                // ä¸æ”¯æŒçš„æµè§ˆå™¨ï¼Œä½¿ç”¨é»˜è®¤ä¸‹è½½ç›®å½•
                showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶å¤¹é€‰æ‹©ï¼Œå°†ä¿å­˜åˆ°é»˜è®¤ä¸‹è½½ç›®å½•ã€‚è¯·ä½¿ç”¨Chrome/Edgeæµè§ˆå™¨');
                exportFolder = 'é»˜è®¤ä¸‹è½½ç›®å½•';
                elements.folderNotSelected.style.display = 'none';
                elements.folderPath.style.display = 'block';
                elements.folderPathText.textContent = 'æµè§ˆå™¨é»˜è®¤ä¸‹è½½ç›®å½•';
                updateBatchControls();
            }
        }
        
        // å¤„ç†é¢„è§ˆæŒ‰é’®
        function handlePreview() {
            if (!backgroundImage) {
                showToast('è¯·å…ˆä¸Šä¼ èƒŒæ™¯å›¾');
                return;
            }
            if (textList.length === 0) {
                showToast('è¯·å…ˆå¯¼å…¥æ–‡å­—æ•°æ®');
                return;
            }
            // é¢„è§ˆå½“å‰é€‰ä¸­çš„æ ‡é¢˜
            showToast('æ­£åœ¨é¢„è§ˆå½“å‰æ ‡é¢˜...');
            updateStatusBar();
        }
        
        // å¤„ç†ç”ŸæˆæŒ‰é’®
        function handleGenerate() {
            if (!backgroundImage) {
                showToast('è¯·å…ˆä¸Šä¼ èƒŒæ™¯å›¾');
                return;
            }
            if (textList.length === 0) {
                showToast('è¯·å…ˆå¯¼å…¥æ–‡å­—æ•°æ®');
                return;
            }
            if (!exportFolder) {
                showToast('è¯·å…ˆé€‰æ‹©å¯¼å‡ºæ–‡ä»¶å¤¹');
                return;
            }
            
            // æ‰¹é‡ç”Ÿæˆæ‰€æœ‰å›¾ç‰‡
            generateAllImages();
        }
        
        // æ›´æ–°çŠ¶æ€æ 
        function updateStatusBar() {
            if (textList.length > 0) {
                elements.statusBar.style.display = 'block';
                const titlePreview = textList[previewIndex] ? textList[previewIndex].split('\n')[0] : '';
                elements.statusText.textContent = `é¢„è§ˆç¬¬ ${previewIndex + 1} å¼ å›¾ç‰‡ - æ˜¾ç¤ºæ ‡é¢˜${previewIndex + 1}`;
            } else {
                elements.statusBar.style.display = 'none';
            }
        }

        // å¼€å§‹æ‹–åŠ¨
        function startDrag(e) {
            if (!backgroundImage) return;
            
            const textContainer = document.querySelector('.preview-text-container');
            if (!textContainer || !textContainer.contains(e.target)) return;
            
            isDragging = true;
            // ä½¿ç”¨å½“å‰çš„åç§»é‡ä½œä¸ºèµ·å§‹ç‚¹ï¼ˆæ— è®ºæ˜¯åˆ—è¡¨æ¨¡å¼è¿˜æ˜¯æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ï¼‰
            dragStartX = e.clientX - offsetX;
            dragStartY = e.clientY - offsetY;
            textContainer.style.cursor = 'grabbing';
            e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
        }

        // æ‹–åŠ¨ä¸­
        function drag(e) {
            if (!isDragging) return;
            
            // è®¡ç®—æ–°çš„åç§»é‡
            const newX = e.clientX - dragStartX;
            const newY = e.clientY - dragStartY;
            
            // é™åˆ¶æ‹–åŠ¨èŒƒå›´
            offsetX = Math.max(-500, Math.min(500, newX));
            offsetY = Math.max(-500, Math.min(500, newY));
            
            // å¦‚æœå½“å‰æœ‰åˆ—è¡¨é¡¹ï¼Œæ›´æ–°åˆ—è¡¨é¡¹çš„åç§»é‡
            if (textList.length > 0 && textOffsets[currentIndex]) {
                textOffsets[currentIndex].x = offsetX;
                textOffsets[currentIndex].y = offsetY;
            }
            
            // æ›´æ–°è¾“å…¥æ¡†çš„æ•°å€¼æ˜¾ç¤º
            elements.positionXInput.value = offsetX;
            elements.positionYInput.value = offsetY;
            
            updatePreviewSmart();
            e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
        }

        // ç»“æŸæ‹–åŠ¨
        function endDrag() {
            if (!isDragging) return;
            isDragging = false;
            const textContainer = document.querySelector('.preview-text-container');
            if (textContainer) {
                textContainer.style.cursor = 'move';
            }
        }
        
        // è‰²å—åŠŸèƒ½å·²ç§»é™¤

        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            // æ¸…ç©ºé¢„è§ˆå®¹å™¨
            elements.previewContainer.innerHTML = '';
            
            // å¦‚æœæ²¡æœ‰èƒŒæ™¯å›¾
            if (!backgroundImage) {
                const emptyPreview = document.createElement('div');
                emptyPreview.classList.add('empty-preview');
                emptyPreview.textContent = 'è¯·å…ˆä¸Šä¼ èƒŒæ™¯å›¾';
                elements.previewContainer.appendChild(emptyPreview);
                return;
            }
            
            // æ·»åŠ èƒŒæ™¯å›¾
            const bgImg = backgroundImage.cloneNode();
            bgImg.classList.add('preview-bg');
            elements.previewContainer.appendChild(bgImg);
            
            // å¦‚æœæ²¡æœ‰æ–‡å­—
            if (textList.length === 0) {
                const emptyText = document.createElement('div');
                emptyText.classList.add('empty-preview');
                emptyText.textContent = 'æš‚æ— æ–‡å­—ï¼Œè¯·å¯¼å…¥ Excel æˆ–æ‰‹åŠ¨æ·»åŠ ';
                elements.previewContainer.appendChild(emptyText);
                return;
            }
            
            // è·å–å½“å‰æ–‡å­—çš„åç§»é‡
            const currentOffset = textOffsets[currentIndex] || {x: 0, y: 0};
            
            // åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å®¹å™¨æ¥æ”¾ç½®æ–‡å­—
            const contentContainer = document.createElement('div');
            contentContainer.style.position = 'relative';
            contentContainer.style.width = '100%';
            contentContainer.style.height = '100%';
            contentContainer.style.overflow = 'hidden';
            
            // æ·»åŠ æ–‡å­—
            const textContainer = document.createElement('div');
            textContainer.classList.add('preview-text-container');
            textContainer.style.position = 'absolute';
            textContainer.style.left = '0';
            textContainer.style.top = '50%';
            textContainer.style.width = '100%';
            textContainer.style.transform = 'translateY(-50%)';
            
            // å¦‚æœæœ‰æ–‡å­—åç§»ï¼Œåˆ™åº”ç”¨åç§»
            if (currentOffset.x !== 0 || currentOffset.y !== 0) {
                textContainer.style.transform = `translate(${currentOffset.x}px, calc(-50% + ${currentOffset.y}px))`;
            }
            
            // ä¸ºæ–‡å­—å®¹å™¨ç»‘å®šæ‹–æ‹½äº‹ä»¶
            textContainer.addEventListener('mousedown', startDrag);
            
            const textElement = document.createElement('div');
            textElement.classList.add('preview-text');
            // å°†ç©ºæ ¼è½¬æ¢ä¸ºä¸é—´æ–­ç©ºæ ¼ï¼Œç¡®ä¿ç©ºæ ¼è¢«æ­£ç¡®æ˜¾ç¤º
            const displayText = textList[currentIndex].replace(/ /g, '\u00A0');
            textElement.textContent = displayText;
            textElement.style.fontFamily = elements.fontSelect.value;
            // æ ¹æ®é¢„è§ˆåŒºåŸŸå°ºå¯¸è°ƒæ•´å­—ä½“å¤§å°ï¼Œé¿å…è¿‡å¤§å¯¼è‡´æ˜¾ç¤ºé—®é¢˜
            const previewFontSize = Math.min(elements.fontSizeInput.value, 56); // é™åˆ¶æœ€å¤§é¢„è§ˆå­—ä½“å¤§å°
            textElement.style.fontSize = `${previewFontSize}px`;
            textElement.style.color = elements.textColorPicker.value;
            textElement.style.position = 'relative';
            // ä¿æŒç©ºæ ¼å’Œæ¢è¡Œçš„æ˜¾ç¤º
            textElement.style.whiteSpace = 'pre-wrap';
            textElement.style.wordWrap = 'break-word';
            textElement.style.overflow = 'hidden';
            // è®¾ç½®åˆé€‚çš„å®½åº¦ä»¥é¿å…è¿‡åº¦æ¢è¡Œ
            textElement.style.maxWidth = '100%';
            textElement.style.margin = '0 auto';
            textElement.style.padding = '0 10px';
            // åŠ ç²—
            if (elements.boldToggle.checked) {
                textElement.style.fontWeight = 'bold';
            } else {
                textElement.style.fontWeight = 'normal';
            }
            // æè¾¹
            if (elements.strokeToggle.checked) {
                textElement.style.webkitTextStroke = `2px ${elements.strokeColorPicker.value}`;
                textElement.style.textStroke = `2px ${elements.strokeColorPicker.value}`;
            } else {
                textElement.style.webkitTextStroke = '';
                textElement.style.textStroke = '';
            }
            
            textContainer.appendChild(textElement);
            contentContainer.appendChild(textContainer);
            elements.previewContainer.appendChild(contentContainer);
            
            // æ·»åŠ è£…é¥°å›¾æ ‡
            if (decorativeIcon) {
                const iconContainer = document.createElement('div');
                iconContainer.style.position = 'absolute';
                iconContainer.style.zIndex = '3';
                iconContainer.style.left = '50%';
                iconContainer.style.top = '50%';
                
                const iconX = parseInt(elements.iconXInput.value) || 0;
                const iconY = parseInt(elements.iconYInput.value) || 0;
                const iconSize = parseInt(elements.iconSizeInput.value) || 80;
                
                iconContainer.style.transform = `translate(calc(-50% + ${iconX}px), calc(-50% + ${iconY}px))`;
                
                const iconImg = decorativeIcon.cloneNode();
                iconImg.style.width = `${iconSize}px`;
                iconImg.style.height = 'auto';
                iconImg.style.display = 'block';
                
                iconContainer.appendChild(iconImg);
                elements.previewContainer.appendChild(iconContainer);
            }
            
            // æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤ºä¸ºå½“å‰æ–‡å­—çš„åç§»é‡
            // ä½†ä¸è¦è¦†ç›–ç”¨æˆ·æ­£åœ¨è¾“å…¥çš„å€¼
            if (document.activeElement !== elements.positionXInput) {
                elements.positionXInput.value = currentOffset.x;
            }
            if (document.activeElement !== elements.positionYInput) {
                elements.positionYInput.value = currentOffset.y;
            }
            offsetX = currentOffset.x;
            offsetY = currentOffset.y;
        }

        // æ›´æ–°é¢„è§ˆï¼ˆä½¿ç”¨æŒ‡å®šçš„æ–‡å­—å†…å®¹ï¼‰
        function updatePreviewWithText(text) {
            // æ¸…ç©ºé¢„è§ˆå®¹å™¨
            elements.previewContainer.innerHTML = '';
            
            // å¦‚æœæ²¡æœ‰èƒŒæ™¯å›¾
            if (!backgroundImage) {
                const emptyPreview = document.createElement('div');
                emptyPreview.classList.add('empty-preview');
                emptyPreview.textContent = 'è¯·å…ˆä¸Šä¼ èƒŒæ™¯å›¾';
                elements.previewContainer.appendChild(emptyPreview);
                return;
            }
            
            // æ·»åŠ èƒŒæ™¯å›¾
            const bgImg = backgroundImage.cloneNode();
            bgImg.classList.add('preview-bg');
            elements.previewContainer.appendChild(bgImg);
            
            // å¦‚æœæ–‡å­—ä¸ºç©º
            if (!text || text === '') {
                const emptyText = document.createElement('div');
                emptyText.classList.add('empty-preview');
                emptyText.textContent = 'æš‚æ— æ–‡å­—ï¼Œè¯·å¯¼å…¥ Excel æˆ–æ‰‹åŠ¨æ·»åŠ ';
                elements.previewContainer.appendChild(emptyText);
                return;
            }
            
            // ä½¿ç”¨å½“å‰å…¨å±€çš„åç§»é‡ï¼ˆæ”¯æŒæ‰‹åŠ¨è¾“å…¥æ¨¡å¼çš„æ‹–æ‹½ï¼‰
            // ç›´æ¥ä»è¾“å…¥æ¡†è¯»å–ï¼Œç¡®ä¿å®æ—¶åŒæ­¥
            const currentOffsetX = parseInt(elements.positionXInput.value) || 0;
            const currentOffsetY = parseInt(elements.positionYInput.value) || 0;
            const currentOffset = {x: currentOffsetX, y: currentOffsetY};
            
            // åŒæ­¥æ›´æ–°å…¨å±€å˜é‡
            offsetX = currentOffsetX;
            offsetY = currentOffsetY;
            
            // åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å®¹å™¨æ¥æ”¾ç½®æ–‡å­—
            const contentContainer = document.createElement('div');
            contentContainer.style.position = 'relative';
            contentContainer.style.width = '100%';
            contentContainer.style.height = '100%';
            contentContainer.style.overflow = 'hidden';
            
            // æ·»åŠ æ–‡å­—
            const textContainer = document.createElement('div');
            textContainer.classList.add('preview-text-container');
            textContainer.style.position = 'absolute';
            textContainer.style.left = '0';
            textContainer.style.top = '50%';
            textContainer.style.width = '100%';
            textContainer.style.transform = 'translateY(-50%)';
            
            // å¦‚æœæœ‰æ–‡å­—åç§»ï¼Œåˆ™åº”ç”¨åç§»
            if (currentOffset.x !== 0 || currentOffset.y !== 0) {
                textContainer.style.transform = `translate(${currentOffset.x}px, calc(-50% + ${currentOffset.y}px))`;
            }
            
            // ä¸ºæ–‡å­—å®¹å™¨ç»‘å®šæ‹–æ‹½äº‹ä»¶
            textContainer.addEventListener('mousedown', startDrag);
            
            const textElement = document.createElement('div');
            textElement.classList.add('preview-text');
            // å°†ç©ºæ ¼è½¬æ¢ä¸ºä¸é—´æ–­ç©ºæ ¼ï¼Œç¡®ä¿ç©ºæ ¼è¢«æ­£ç¡®æ˜¾ç¤º
            const displayText = text.replace(/ /g, '\u00A0');
            textElement.textContent = displayText;
            textElement.style.fontFamily = elements.fontSelect.value;
            // æ ¹æ®é¢„è§ˆåŒºåŸŸå°ºå¯¸è°ƒæ•´å­—ä½“å¤§å°ï¼Œé¿å…è¿‡å¤§å¯¼è‡´æ˜¾ç¤ºé—®é¢˜
            const previewFontSize = Math.min(elements.fontSizeInput.value, 56); // é™åˆ¶æœ€å¤§é¢„è§ˆå­—ä½“å¤§å°
            textElement.style.fontSize = `${previewFontSize}px`;
            textElement.style.color = elements.textColorPicker.value;
            textElement.style.position = 'relative';
            // ä¿æŒç©ºæ ¼å’Œæ¢è¡Œçš„æ˜¾ç¤º
            textElement.style.whiteSpace = 'pre-wrap';
            textElement.style.wordWrap = 'break-word';
            textElement.style.overflow = 'hidden';
            // è®¾ç½®åˆé€‚çš„å®½åº¦ä»¥é¿å…è¿‡åº¦æ¢è¡Œ
            textElement.style.maxWidth = '100%';
            textElement.style.margin = '0 auto';
            textElement.style.padding = '0 10px';
            // åŠ ç²—
            if (elements.boldToggle.checked) {
                textElement.style.fontWeight = 'bold';
            } else {
                textElement.style.fontWeight = 'normal';
            }
            // æè¾¹
            if (elements.strokeToggle.checked) {
                textElement.style.webkitTextStroke = `2px ${elements.strokeColorPicker.value}`;
                textElement.style.textStroke = `2px ${elements.strokeColorPicker.value}`;
            } else {
                textElement.style.webkitTextStroke = '';
                textElement.style.textStroke = '';
            }
            
            textContainer.appendChild(textElement);
            contentContainer.appendChild(textContainer);
            elements.previewContainer.appendChild(contentContainer);
            
            // æ·»åŠ è£…é¥°å›¾æ ‡
            if (decorativeIcon) {
                const iconContainer = document.createElement('div');
                iconContainer.style.position = 'absolute';
                iconContainer.style.zIndex = '3';
                iconContainer.style.left = '50%';
                iconContainer.style.top = '50%';
                
                const iconX = parseInt(elements.iconXInput.value) || 0;
                const iconY = parseInt(elements.iconYInput.value) || 0;
                const iconSize = parseInt(elements.iconSizeInput.value) || 80;
                
                iconContainer.style.transform = `translate(calc(-50% + ${iconX}px), calc(-50% + ${iconY}px))`;
                
                const iconImg = decorativeIcon.cloneNode();
                iconImg.style.width = `${iconSize}px`;
                iconImg.style.height = 'auto';
                iconImg.style.display = 'block';
                
                iconContainer.appendChild(iconImg);
                elements.previewContainer.appendChild(iconContainer);
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message) {
            elements.notification.textContent = message;
            elements.notification.classList.add('show');
            
            setTimeout(() => {
                elements.notification.classList.remove('show');
            }, 3000);
        }

        // å¯¼å‡ºå›¾ç‰‡
        function exportImage() {
            if (!backgroundImage || textList.length === 0) {
                showToast('è¯·å…ˆä¸Šä¼ èƒŒæ™¯å›¾å¹¶æ·»åŠ æ–‡å­—');
                return;
            }
            
            // åˆ›å»ºä¸€ä¸ªcanvaså…ƒç´ 
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // è®¾ç½®canvaså°ºå¯¸ä¸åŸå§‹èƒŒæ™¯å›¾ç›¸åŒï¼Œä»¥ä¿æŒæœ€ä½³è´¨é‡
            canvas.width = backgroundImage.width;
            canvas.height = backgroundImage.height;
            
            // ç»˜åˆ¶èƒŒæ™¯å›¾
            ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
            
            // è·å–å½“å‰æ–‡å­—å’Œæ ·å¼è®¾ç½®
            const currentText = textList[currentIndex];
            const fontFamily = elements.fontSelect.value;
            const fontSize = elements.fontSizeInput.value;
            const textColor = elements.textColorPicker.value;
            const isBold = elements.boldToggle.checked;
            const hasStroke = elements.strokeToggle.checked;
            const strokeColor = elements.strokeColorPicker.value;
            
            // è·å–å½“å‰æ–‡å­—çš„åç§»é‡
            const currentOffset = textOffsets[currentIndex] || {x: 0, y: 0};
            
            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            const scaleX = canvas.width / 400;
            const scaleY = canvas.height / 533;
            
            // è®¾ç½®æ–‡å­—æ ·å¼ï¼ˆå­—ä½“å¤§å°éœ€è¦æŒ‰æ¯”ä¾‹ç¼©æ”¾ï¼‰
            const fontWeight = isBold ? 'bold' : 'normal';
            const scaledFontSize = fontSize * scaleY; // æŒ‰Yè½´æ¯”ä¾‹ç¼©æ”¾å­—ä½“å¤§å°
            ctx.font = `${fontWeight} ${scaledFontSize}px ${fontFamily}`;
            ctx.textAlign = 'center';
            ctx.fillStyle = textColor;
            
            // è®¡ç®—æ–‡å­—ä½ç½®ï¼ˆè€ƒè™‘åç§»ï¼‰
            const x = (canvas.width / 2) + (currentOffset.x * scaleX);
            const y = (canvas.height / 2) + (currentOffset.y * scaleY);
            
            // ç»˜åˆ¶æ–‡å­—ï¼ˆæ”¯æŒå¤šè¡Œï¼‰
            const lines = currentText.split('\n');
            const lineHeight = scaledFontSize * 1.2;
            const startY = y - (lines.length - 1) * lineHeight / 2;
            
            // è‰²å—åŠŸèƒ½å·²ç§»é™¤
            
            for (let i = 0; i < lines.length; i++) {
                const lineY = startY + i * lineHeight;
                
                // å¦‚æœæœ‰æè¾¹ï¼Œå…ˆç»˜åˆ¶æè¾¹
                if (hasStroke) {
                    ctx.strokeStyle = strokeColor;
                    ctx.lineWidth = 4 * scaleY; // æè¾¹å®½åº¦ä¹Ÿè¦ç¼©æ”¾
                    ctx.strokeText(lines[i], x, lineY);
                }
                // ç»˜åˆ¶æ–‡å­—
                ctx.fillStyle = textColor;
                ctx.fillText(lines[i], x, lineY);
            }
            
            // å¦‚æœæœ‰è£…é¥°å›¾æ ‡ï¼Œç»˜åˆ¶å›¾æ ‡
            if (decorativeIcon) {
                const iconX = parseInt(elements.iconXInput.value) || 0;
                const iconY = parseInt(elements.iconYInput.value) || 0;
                const iconSize = parseInt(elements.iconSizeInput.value) || 80;
                
                // è®¡ç®—å›¾æ ‡åœ¨ç”»å¸ƒä¸Šçš„ä½ç½®
                const canvasIconX = (canvas.width / 2) + (iconX * scaleX);
                const canvasIconY = (canvas.height / 2) + (iconY * scaleY);
                const scaledIconSize = iconSize * scaleY;
                
                // ç»˜åˆ¶å›¾æ ‡
                ctx.drawImage(
                    decorativeIcon,
                    canvasIconX - (scaledIconSize / 2),
                    canvasIconY - (scaledIconSize / 2),
                    scaledIconSize,
                    scaledIconSize
                );
            }
            
            // å¯¼å‡ºå›¾ç‰‡
            const dataURL = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = `å°çº¢ä¹¦å›¾æ–‡_${currentIndex + 1}.png`;
            link.href = dataURL;
            link.click();
            
            showToast('å›¾ç‰‡å¯¼å‡ºæˆåŠŸ');
        }
        
        // æ‰¹é‡ç”Ÿæˆæ‰€æœ‰å›¾ç‰‡
        async function generateAllImages() {
            if (!backgroundImage || textList.length === 0) {
                showToast('è¯·å…ˆä¸Šä¼ èƒŒæ™¯å›¾å¹¶å¯¼å…¥æ–‡å­—');
                return;
            }
            
            showToast(`å¼€å§‹ç”Ÿæˆ ${textList.length} å¼ å›¾ç‰‡...`);
            
            // å¦‚æœæ”¯æŒæ–‡ä»¶å¤¹é€‰æ‹©ä¸”å·²é€‰æ‹©æ–‡ä»¶å¤¹ï¼Œä½¿ç”¨ File System Access API
            if (exportFolderHandle) {
                try {
                    for (let index = 0; index < textList.length; index++) {
                        const currentText = textList[index];
                        const currentOffset = textOffsets[index] || {x: 0, y: 0};
                        const currentId = idList[index] || `å›¾ç‰‡${index + 1}`;
                        
                        // ç”Ÿæˆcanvas
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = backgroundImage.width;
                        canvas.height = backgroundImage.height;
                        ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
                        
                        // è·å–æ ·å¼è®¾ç½®
                        const fontFamily = elements.fontSelect.value;
                        const fontSize = elements.fontSizeInput.value;
                        const textColor = elements.textColorPicker.value;
                        const isBold = elements.boldToggle.checked;
                        const hasStroke = elements.strokeToggle.checked;
                        const strokeColor = elements.strokeColorPicker.value;
                        
                        // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
                        const scaleX = canvas.width / 400;
                        const scaleY = canvas.height / 533;
                        
                        // è®¾ç½®æ–‡å­—æ ·å¼
                        const fontWeight = isBold ? 'bold' : 'normal';
                        const scaledFontSize = fontSize * scaleY;
                        ctx.font = `${fontWeight} ${scaledFontSize}px ${fontFamily}`;
                        ctx.textAlign = 'center';
                        ctx.fillStyle = textColor;
                        
                        // è®¡ç®—æ–‡å­—ä½ç½®
                        const x = (canvas.width / 2) + (currentOffset.x * scaleX);
                        const y = (canvas.height / 2) + (currentOffset.y * scaleY);
                        
                        // ç»˜åˆ¶æ–‡å­—ï¼ˆæ”¯æŒå¤šè¡Œï¼‰
                        const lines = currentText.split('\n');
                        const lineHeight = scaledFontSize * 1.2;
                        const startY = y - (lines.length - 1) * lineHeight / 2;
                        
                        // è‰²å—åŠŸèƒ½å·²ç§»é™¤
                        
                        for (let i = 0; i < lines.length; i++) {
                            const lineY = startY + i * lineHeight;
                            if (hasStroke) {
                                ctx.strokeStyle = strokeColor;
                                ctx.lineWidth = 4 * scaleY;
                                ctx.strokeText(lines[i], x, lineY);
                            }
                            ctx.fillStyle = textColor;
                            ctx.fillText(lines[i], x, lineY);
                        }
                        
                        // å¦‚æœæœ‰è£…é¥°å›¾æ ‡ï¼Œç»˜åˆ¶å›¾æ ‡
                        if (decorativeIcon) {
                            const iconX = parseInt(elements.iconXInput.value) || 0;
                            const iconY = parseInt(elements.iconYInput.value) || 0;
                            const iconSize = parseInt(elements.iconSizeInput.value) || 80;
                            
                            // è®¡ç®—å›¾æ ‡åœ¨ç”»å¸ƒä¸Šçš„ä½ç½®
                            const canvasIconX = (canvas.width / 2) + (iconX * scaleX);
                            const canvasIconY = (canvas.height / 2) + (iconY * scaleY);
                            const scaledIconSize = iconSize * scaleY;
                            
                            // ç»˜åˆ¶å›¾æ ‡
                            ctx.drawImage(
                                decorativeIcon,
                                canvasIconX - (scaledIconSize / 2),
                                canvasIconY - (scaledIconSize / 2),
                                scaledIconSize,
                                scaledIconSize
                            );
                        }
                        
                        // ä¿å­˜åˆ°é€‰å®šçš„æ–‡ä»¶å¤¹
                        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                        const fileName = `${currentId}.png`;
                        const fileHandle = await exportFolderHandle.getFileHandle(fileName, { create: true });
                        const writable = await fileHandle.createWritable();
                        await writable.write(blob);
                        await writable.close();
                        
                        showToast(`å·²ç”Ÿæˆ ${index + 1}/${textList.length}`);
                    }
                    showToast(`æ‰€æœ‰å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼å…± ${textList.length} å¼ `);
                } catch (error) {
                    console.error('ä¿å­˜æ–‡ä»¶å¤±è´¥:', error);
                    showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å¤¹æƒé™');
                }
                return;
            }
            
            // ä½¿ç”¨ä¼ ç»Ÿä¸‹è½½æ–¹å¼ï¼ˆé»˜è®¤ä¸‹è½½ç›®å½•ï¼‰
            let count = 0;
            const generateNext = () => {
                if (count >= textList.length) {
                    showToast(`æ‰€æœ‰å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼å…± ${textList.length} å¼ `);
                    return;
                }
                
                const index = count;
                const currentText = textList[index];
                const currentOffset = textOffsets[index] || {x: 0, y: 0};
                const currentId = idList[index] || `å›¾ç‰‡${index + 1}`;
                
                // åˆ›å»ºä¸€ä¸ªcanvaså…ƒç´ 
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // è®¾ç½®canvaså°ºå¯¸ä¸åŸå§‹èƒŒæ™¯å›¾ç›¸åŒ
                canvas.width = backgroundImage.width;
                canvas.height = backgroundImage.height;
                
                // ç»˜åˆ¶èƒŒæ™¯å›¾
                ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
                
                // è·å–æ ·å¼è®¾ç½®
                const fontFamily = elements.fontSelect.value;
                const fontSize = elements.fontSizeInput.value;
                const textColor = elements.textColorPicker.value;
                const isBold = elements.boldToggle.checked;
                const hasStroke = elements.strokeToggle.checked;
                const strokeColor = elements.strokeColorPicker.value;
                
                // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
                const scaleX = canvas.width / 400;  // é¢„è§ˆå®½åº¦
                const scaleY = canvas.height / 533; // é¢„è§ˆé«˜åº¦
                
                // è®¾ç½®æ–‡å­—æ ·å¼ï¼ˆå­—ä½“å¤§å°éœ€è¦æŒ‰æ¯”ä¾‹ç¼©æ”¾ï¼‰
                const fontWeight = isBold ? 'bold' : 'normal';
                const scaledFontSize = fontSize * scaleY; // æŒ‰Yè½´æ¯”ä¾‹ç¼©æ”¾å­—ä½“å¤§å°
                ctx.font = `${fontWeight} ${scaledFontSize}px ${fontFamily}`;
                ctx.textAlign = 'center';
                ctx.fillStyle = textColor;
                
                // è®¡ç®—æ–‡å­—ä½ç½®
                const x = (canvas.width / 2) + (currentOffset.x * scaleX);
                const y = (canvas.height / 2) + (currentOffset.y * scaleY);
                
                // ç»˜åˆ¶æ–‡å­—ï¼ˆæ”¯æŒå¤šè¡Œï¼‰
                const lines = currentText.split('\n');
                const lineHeight = scaledFontSize * 1.2;
                const startY = y - (lines.length - 1) * lineHeight / 2;
                                        
                // å¦‚æœå¯ç”¨äº†é«˜äº®è‰²å—ï¼Œå…ˆç»˜åˆ¶è‰²å—
                if (elements.highlightToggle.checked) {
                    const highlightColor = elements.highlightColorPicker.value;
                    const highlightOpacity = elements.highlightOpacityInput.value / 100;
                    const highlightHeightPercent = elements.highlightHeightInput.value;
                    const highlightPosition = elements.highlightPositionSelect.value;
                                            
                    // è®¾ç½®è‰²å—é¢œè‰²ï¼ˆå¸¦é€æ˜åº¦ï¼‰
                    const r = parseInt(highlightColor.substr(1, 2), 16);
                    const g = parseInt(highlightColor.substr(3, 2), 16);
                    const b = parseInt(highlightColor.substr(5, 2), 16);
                    ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${highlightOpacity})`;
                                            
                    // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰ä½ç½®å’Œå°ºå¯¸
                    if (highlightCustomPositions[index] && highlightCustomSizes[index] && highlightPosition === 'custom') {
                        // ä½¿ç”¨è‡ªå®šä¹‰ä½ç½®å’Œå°ºå¯¸
                        const customX = (canvas.width / 2) + (highlightCustomPositions[index].x * scaleX);
                        const customY = (canvas.height / 2) + (highlightCustomPositions[index].y * scaleY);
                        const customWidth = highlightCustomSizes[index].width * scaleX;
                        const customHeight = highlightCustomSizes[index].height * scaleY;
                        
                        ctx.fillRect(customX, customY, customWidth, customHeight);
                    } else {
                        // ä½¿ç”¨é¢„è®¾ä½ç½®
                        // è®¡ç®—æ–‡å­—æ•´ä½“çš„é«˜åº¦
                        const textTotalHeight = lines.length * lineHeight;
                        const highlightHeight = textTotalHeight * (highlightHeightPercent / 100);
                                            
                        let highlightY;
                        if (highlightPosition === 'bottom') {
                            highlightY = startY + textTotalHeight - highlightHeight;
                        } else if (highlightPosition === 'middle') {
                            highlightY = startY + (textTotalHeight / 2) - (highlightHeight / 2);
                        } else if (highlightPosition === 'top') {
                            highlightY = startY;
                        }
                                            
                        ctx.fillRect(x - 200 * scaleX, highlightY, 400 * scaleX, highlightHeight);
                    }
                }
                                        
                for (let i = 0; i < lines.length; i++) {
                    const lineY = startY + i * lineHeight;
                                            
                    // å¦‚æœæœ‰æè¾¹ï¼Œå…ˆç»˜åˆ¶æè¾¹
                    if (hasStroke) {
                        ctx.strokeStyle = strokeColor;
                        ctx.lineWidth = 4 * scaleY; // æè¾¹å®½åº¦ä¹Ÿè¦ç¼©æ”¾
                        ctx.strokeText(lines[i], x, lineY);
                    }
                    // ç»˜åˆ¶æ–‡å­—
                    ctx.fillStyle = textColor;
                    ctx.fillText(lines[i], x, lineY);
                }
                                        
                // å¦‚æœæœ‰è£…é¥°å›¾æ ‡ï¼Œç»˜åˆ¶å›¾æ ‡
                if (decorativeIcon) {
                    const iconX = parseInt(elements.iconXInput.value) || 0;
                    const iconY = parseInt(elements.iconYInput.value) || 0;
                    const iconSize = parseInt(elements.iconSizeInput.value) || 80;
                                            
                    // è®¡ç®—å›¾æ ‡åœ¨ç”»å¸ƒä¸Šçš„ä½ç½®
                    const canvasIconX = (canvas.width / 2) + (iconX * scaleX);
                    const canvasIconY = (canvas.height / 2) + (iconY * scaleY);
                    const scaledIconSize = iconSize * scaleY;
                                            
                    // ç»˜åˆ¶å›¾æ ‡
                    ctx.drawImage(
                        decorativeIcon,
                        canvasIconX - (scaledIconSize / 2),
                        canvasIconY - (scaledIconSize / 2),
                        scaledIconSize,
                        scaledIconSize
                    );
                }
                
                // å¯¼å‡ºå›¾ç‰‡
                const dataURL = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `${currentId}.png`; // ä½¿ç”¨IDä½œä¸ºæ–‡ä»¶å
                link.href = dataURL;
                link.click();
                
                count++;
                
                // å»¶è¿Ÿ100mså†ç”Ÿæˆä¸‹ä¸€å¼ ï¼Œé¿å…æµè§ˆå™¨é˜»æ­¢
                setTimeout(generateNext, 100);
            };
            
            generateNext();
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>